<!doctype html>
<html lang="bg">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Преглед на документ</title>
        <link rel="stylesheet" href="style.css" />

        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
        <script>
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
        </script>

        <style>
            body.viewer-body {
                background-color: #333;
                margin: 0;
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            .toolbar {
                background-color: #1a1a1a;
                color: white;
                padding: 10px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
                z-index: 10;
                flex-shrink: 0; /* Лентата не се свива */
            }

            .toolbar-group {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .btn-tool {
                background: #444;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9rem;
                user-select: none;
            }
            .btn-tool:hover {
                background: #666;
            }

            .page-info {
                font-family: monospace;
                font-size: 1rem;
                user-select: none;
            }

            .back-btn-custom {
                text-decoration: none;
                color: white;
                font-weight: bold;
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .back-btn-custom:hover {
                color: #fca311;
            }

            /* --- ПОПРАВКАТА Е ТУК --- */
            #canvas-container {
                flex: 1;
                overflow: auto; /* Позволява скрол и хоризонтално, и вертикално */
                display: flex;
                /* Премахнахме justify-content: center, за да не се реже при зуум */
                align-items: flex-start;
                padding: 20px;
                position: relative;
                background: #525659;
                justify-content: center; /* Центрира само ако е по-малък от екрана */
            }

            canvas {
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
                display: block;
                /* ВАЖНО: Премахнахме max-width, за да може да расте! */
            }

            .loader {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                font-size: 1.2rem;
                text-align: center;
                pointer-events: none;
            }
        </style>
    </head>
    <body class="viewer-body">
        <div class="toolbar">
            <div class="toolbar-group">
                <a href="index.html" class="back-btn-custom">Назад</a>
            </div>

            <div class="toolbar-group">
                <button class="btn-tool" id="prev">◀</button>
                <span class="page-info"> <span id="page-num">--</span> / <span id="page-count">--</span> </span>
                <button class="btn-tool" id="next">▶</button>
            </div>

            <div class="toolbar-group">
                <button class="btn-tool" id="zoom-out">Намали</button>
                <button class="btn-tool" id="zoom-in">Увеличи</button>
                <a
                    id="download-btn"
                    href="#"
                    target="_blank"
                    class="btn-tool"
                    style="text-decoration: none; background: #fca311; color: black"
                    >Изтегли</a
                >
            </div>
        </div>

        <div id="canvas-container">
            <div id="loader" class="loader">Зареждане на документа...</div>
            <canvas id="the-canvas"></canvas>
        </div>

        <script>
            let pdfDoc = null;
            let pageNum = 1;
            let pageRendering = false;
            let pageNumPending = null;
            let scale = 1.0; // Започваме от 100%

            const canvas = document.getElementById("the-canvas");
            const ctx = canvas.getContext("2d");
            const urlParams = new URLSearchParams(window.location.search);
            let url = urlParams.get("src");

            if (url) {
                document.getElementById("download-btn").href = url;
                // Прокси само за външни линкове
                if (url.startsWith("http")) {
                    url = "https://corsproxy.io/?" + encodeURIComponent(url);
                }
            }

            function renderPage(num) {
                pageRendering = true;

                pdfDoc.getPage(num).then(function (page) {
                    // Тук магията се случва: scale определя реалните пиксели
                    const viewport = page.getViewport({ scale: scale });

                    // Задаваме реалните размери на елемента
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    // Canvas CSS размерите се адаптират автоматично, защото махнахме max-width

                    const renderContext = {
                        canvasContext: ctx,
                        viewport: viewport,
                    };

                    const renderTask = page.render(renderContext);

                    renderTask.promise.then(function () {
                        pageRendering = false;
                        if (pageNumPending !== null) {
                            renderPage(pageNumPending);
                            pageNumPending = null;
                        }
                    });
                });

                document.getElementById("page-num").textContent = num;
            }

            function queueRenderPage(num) {
                if (pageRendering) {
                    pageNumPending = num;
                } else {
                    renderPage(num);
                }
            }

            // --- ZOOM ЛОГИКА ---
            document.getElementById("zoom-in").addEventListener("click", () => {
                if (!pdfDoc) return;
                scale += 0.25; // Увеличаваме с 25%
                queueRenderPage(pageNum);
            });

            document.getElementById("zoom-out").addEventListener("click", () => {
                if (!pdfDoc) return;
                if (scale <= 0.25) return;
                scale -= 0.25; // Намаляваме с 25%
                queueRenderPage(pageNum);
            });

            // Навигация
            document.getElementById("prev").addEventListener("click", () => {
                if (!pdfDoc || pageNum <= 1) return;
                pageNum--;
                queueRenderPage(pageNum);
            });

            document.getElementById("next").addEventListener("click", () => {
                if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
                pageNum++;
                queueRenderPage(pageNum);
            });

            // Зареждане
            if (url) {
                pdfjsLib
                    .getDocument(url)
                    .promise.then(function (pdfDoc_) {
                        pdfDoc = pdfDoc_;
                        document.getElementById("page-count").textContent = pdfDoc.numPages;
                        document.getElementById("loader").style.display = "none";
                        renderPage(pageNum);
                    })
                    .catch(function (error) {
                        console.error("Error:", error);
                        document.getElementById("loader").innerHTML =
                            'Грешка.<br><a style="color:#fca311" href="' +
                            urlParams.get("src") +
                            '" target="_blank">Свали файла</a>';
                    });
            } else {
                document.getElementById("loader").textContent = "Няма файл.";
            }
        </script>
    </body>
</html>
