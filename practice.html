<!doctype html>
<html lang="bg">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Тест</title>
        <link rel="stylesheet" href="css/style.css" />

        <!-- Added internal styles for the toggle functionality -->
        <style>
            /* Basic layout assumption to ensure toggle works */
            .workspace {
                display: flex;
                height: 100vh;
                overflow: hidden;
            }
        </style>
    </head>

    <body class="practice-mode">
        <div class="workspace">
            <div class="pdf-box">
                <iframe id="pdf-frame" src=""></iframe>
            </div>

            <div class="sheet-box">
                <h3 id="exam-title" style="margin: 0 0 1.5rem 0">Зареждане...</h3>

                <div id="questions"></div>

                <button class="submit-btn" onclick="checkAnswers()">Предай теста</button>
                <div id="score-box" class="score-box"></div>
            </div>
        </div>

        <script>
            let correctKeys = [];
            let userPicks = {};

            // Мапинг: Латиница (JSON) -> Кирилица (Екран)
            const labelsMap = {
                A: "А",
                B: "Б",
                C: "В",
                D: "Г",
            };

            window.onload = async () => {
                const id = new URLSearchParams(window.location.search).get("id");
                if (!id) return alert("Грешка: Няма избран изпит!");

                try {
                    // 1. Зареждане на PDF (с handle за missing file)
                    const pdfFrame = document.getElementById("pdf-frame");
                    const pdfBox = pdfFrame.parentElement;

                    // Опит да се зареди PDF, но не го блокираме ако не успее
                    fetch(`data/${id}.pdf`)
                        .then((response) => {
                            if (!response.ok) {
                                // Скрий PDF box ако няма PDF
                                pdfBox.style.display = "none";
                            } else {
                                pdfFrame.src = `data/${id}.pdf`;
                            }
                        })
                        .catch(() => {
                            // Скрий PDF box при грешка
                            pdfBox.style.display = "none";
                        });

                    // 2. Зареждане на Регистъра за заглавие
                    const registryRes = await fetch("registry.json");
                    const registryData = await registryRes.json();
                    let examTitle = "Неизвестен тест";

                    // Търси в университетските изпити
                    const uniExam = registryData.university.find((e) => e.id === id);
                    if (uniExam) examTitle = uniExam.title;

                    // Търси в матурите
                    const maturaExam = registryData.matura.find((e) => e.id === id);
                    if (maturaExam) examTitle = maturaExam.title;

                    // 3. Зареждане на Отговорите
                    const res = await fetch(`data/${id}_ans.json`);
                    const data = await res.json();

                    document.getElementById("exam-title").innerText = examTitle;
                    correctKeys = data.answers;

                    // Генериране на бланката
                    renderSheet(correctKeys.length);
                } catch (e) {
                    console.log(e);
                    alert("Грешка при зареждане на данните.");
                }
            };

            function renderSheet(count) {
                const container = document.getElementById("questions");
                container.innerHTML = ""; // Изчистване при презареждане

                for (let i = 0; i < count; i++) {
                    const row = document.createElement("div");
                    row.className = "question-row";

                    // Номер на въпроса
                    row.innerHTML = `<div class="q-num">${i + 1}.</div>`;

                    const bubbles = document.createElement("div");
                    bubbles.className = "bubbles";

                    // Тук въртим латинските ключове (за логиката), но показваме кирилица
                    ["A", "B", "C", "D"].forEach((key) => {
                        const b = document.createElement("div");
                        b.className = "bubble";

                        // ВАЖНО: Визуално показваме БГ буквата
                        b.innerText = labelsMap[key];

                        // ID-то остава с латинска буква за CSS и логика
                        b.id = `q${i}_${key}`;

                        // При клик изпращаме латинския ключ 'key' (A, B...), за да съвпада с JSON-a
                        b.onclick = () => select(i, key);

                        bubbles.appendChild(b);
                    });

                    row.appendChild(bubbles);
                    container.appendChild(row);
                }
            }

            function select(idx, key) {
                userPicks[idx] = key; // Записваме латинската буква (напр. "B")

                // Махаме класа 'selected' от всички в реда
                ["A", "B", "C", "D"].forEach((k) => {
                    document.getElementById(`q${idx}_${k}`).classList.remove("selected");
                });

                // Слагаме 'selected' на натиснатия
                document.getElementById(`q${idx}_${key}`).classList.add("selected");
            }

            function checkAnswers() {
                let points = 0;

                correctKeys.forEach((correctKey, i) => {
                    const userKey = userPicks[i];

                    // Проверка
                    if (userKey === correctKey) {
                        points++;
                    }

                    // Оцветяване (Ако потребителят е дал отговор)
                    if (userKey) {
                        const isCorrect = userKey === correctKey;
                        document.getElementById(`q${i}_${userKey}`).classList.add(isCorrect ? "correct" : "wrong");
                    }

                    // Винаги показваме верния отговор в зелено
                    document.getElementById(`q${i}_${correctKey}`).classList.add("correct");
                });

                // Показване на кутията с резултата (беше скрита досега)
                const box = document.getElementById("score-box");
                box.style.display = "block";
                box.innerHTML = `Резултат: <span style="font-size:1.5em">${points}</span> / ${correctKeys.length}`;

                // Автоматично скролване до резултата
                document.querySelector(".sheet-box").scrollTop = document.querySelector(".sheet-box").scrollHeight;
            }
        </script>
    </body>
</html>
